<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3 ç§’å¹³å‡åˆ†è²ï¼ˆ0 dBæ ¡æº– + è¶…æ¨™æç¤º + å¸¸äº® + æŠ˜ç·šåœ–ï¼‰</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: -apple-system, system-ui, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif; margin:0; padding:24px; background:#0b0f14; color:#e6eef7; }
    h1 { font-size:20px; margin:0 0 8px; }
    .row { display:flex; gap:12px; margin:12px 0 12px; flex-wrap:wrap; }
    button, select {
      padding:12px 14px; font-size:16px; border-radius:12px; border:none; cursor:pointer;
      background:#1e88e5; color:#fff;
    }
    button.secondary { background:#455a64; }
    button.ghost { background:transparent; border:1px solid #2b3b53; color:#e6eef7; }
    select { background:#121821; border:1px solid #223047; color:#e6eef7; }
    .panel { background:#121821; border:1px solid #223047; border-radius:16px; padding:16px; transition:background .3s, border-color .3s; }
    .panel.alert { background:#8d6e00; border-color:#ffeb3b; }
    .big { font-size:44px; font-weight:700; letter-spacing:.5px; }
    .label { opacity:.8; font-size:14px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .hint { font-size:13px; opacity:.75; margin-top:10px; line-height:1.45; }
    .ok { color:#80cbc4; }
    .warn { color:#ffab91; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #2b3b53; margin-left:6px; }
    .flash { box-shadow:0 0 0 3px rgba(255,87,34,.45) inset; }
    canvas { display:block; width:100%; height:180px; margin-top:16px; border:1px solid #223047; border-radius:8px; background:#0b0f14; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>ğŸ“¢ 3 ç§’å¹³å‡åˆ†è²ï¼ˆç›¸å°æ ¡æº– 0 dBï¼‰</h1>

  <div class="row">
    <button id="startBtn">é–‹å§‹é‡åº¦</button>
    <button id="stopBtn" class="secondary" disabled>åœæ­¢é‡åº¦</button>
    <button id="calBtn" class="secondary" disabled>é‡æ–°æ ¡æº–ï¼ˆ1 ç§’ï¼‰</button>
    <select id="threshSel" title="è¶…æ¨™æç¤ºé–¾å€¼" disabled>
      <option value="15" selected>æç¤ºï¼š15 dB</option>
      <option value="20">æç¤ºï¼š20 dB</option>
      <option value="25">æç¤ºï¼š25 dB</option>
      <option value="30">æç¤ºï¼š30 dB</option>
    </select>
    <button id="alertToggle" class="ghost" disabled>ğŸ”” æç¤ºå·²é—œ</button>
    <button id="wakeToggle" class="ghost">ğŸ’¡ è¢å¹•å¸¸äº®ï¼šé—œ</button>
  </div>

  <div id="panel" class="panel">
    <div class="label">æœ€è¿‘ 3 ç§’å¹³å‡</div>
    <div id="dbOut" class="big mono">0.0 dB</div>
    <div class="label">
      ç‹€æ…‹ï¼š<span id="status">æœªé–‹å§‹</span>
      <span id="calBadge" class="badge">æœªæ ¡æº–</span>
    </div>
    <div class="label">é–¾å€¼ï¼š<span id="threshLabel" class="ok">15 dB</span></div>
  </div>

  <canvas id="dbChart"></canvas>

  <div class="hint">
    â€¢ æŒ‰ã€Œé–‹å§‹é‡åº¦ã€å³æ™‚æ¸…ç©ºåœ–è¡¨ä¸¦é–‹å§‹å¾ 0 ç§’è¨˜éŒ„ï¼Œæ¯ç§’åŠ å…¥ 1 é»ï¼›æŒ‰ã€Œåœæ­¢é‡åº¦ã€åœæ­¢è¨˜éŒ„ã€‚<br/>
    â€¢ æŒ‰ã€ŒğŸ”” æç¤ºå·²é–‹ã€æœƒç«‹å³é‡æ–°æ ¡æº–èƒŒæ™¯ç‚º 0 dBï¼Œä¸¦æ¸…ç©ºåœ–è¡¨ã€‚<br/>
    â€¢ åœ–ä¸Šä»¥é»ƒè‰²è™›ç·šè¡¨ç¤ºç•¶å‰æç¤ºåˆ†è²é–¾å€¼ï¼›Y è»¸æ¯ 5 dB ä¸€æ ¼ã€‚
  </div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const calBtn   = document.getElementById('calBtn');
    const dbOut    = document.getElementById('dbOut');
    const statusEl = document.getElementById('status');
    const calBadge = document.getElementById('calBadge');
    const panelEl  = document.getElementById('panel');
    const threshSel= document.getElementById('threshSel');
    const threshText = document.getElementById('threshLabel');
    const alertToggle= document.getElementById('alertToggle');
    const wakeToggle = document.getElementById('wakeToggle');

    const canvas = document.getElementById('dbChart');
    const ctx    = canvas.getContext('2d');

    let audioCtx, analyser, source, stream;
    let refPower = null;     // 0 dB åƒè€ƒ
    const frameBuf = [];     // {t, p} 3ç§’è¦–çª—
    const WINDOW_MS = 3000;
    const CAL_MS = 1000;

    let isRunning = false;
    let rafId = null;

    // æç¤ºèˆ‡é–¾å€¼
    let alertEnabled = false;
    let thresholdDb = 15;
    let lastBeepAt = 0;
    const BEEP_COOLDOWN_MS = 2000;

    // è¨˜éŒ„æ™‚é–“è»¸
    let startedAt = null;         // ms èµ·é»
    let lastRecordSec = -1;       // ä¸Šæ¬¡å¯«å…¥çš„æ•´ç§’

    // --- ç•«é–¾å€¼ç·šçš„ plugin ---
    const thresholdLine = {
      id: 'thresholdLine',
      beforeDraw(chart){
        const {ctx, chartArea:{left,right,top}, scales:{y}} = chart;
        if (!y) return;
        const yPos = y.getPixelForValue(thresholdDb);
        ctx.save();
        ctx.strokeStyle = '#ffeb3b'; ctx.lineWidth = 2; ctx.setLineDash([6,4]);
        ctx.beginPath(); ctx.moveTo(left, yPos); ctx.lineTo(right, yPos); ctx.stroke();
        ctx.setLineDash([]); ctx.fillStyle = '#ffeb3b'; ctx.font = '12px sans-serif';
        ctx.fillText(`é–¾å€¼ ${thresholdDb} dB`, right - 110, Math.max(top+12, yPos-6));
        ctx.restore();
      }
    };

    // Chart.js æŠ˜ç·šåœ–ï¼ˆY è»¸æ¯ 5 dB ä¸€æ ¼ï¼‰
    const chart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{ data: [], borderColor:'#80cbc4', backgroundColor:'rgba(128,203,196,.25)', fill:true, tension:.2, pointRadius:0 }] },
      options: {
        animation: false,
        scales: {
          x: { title:{display:true, text:'æ™‚é–“ (ç§’)'} },
          y: { title:{display:true, text:'dB'}, suggestedMin:-50, suggestedMax:50, ticks:{ stepSize:5 } }
        },
        plugins: { legend:{display:false} }
      },
      plugins: [thresholdLine]
    });

    function toDbRel(power, refPwr){ if(!refPwr||power<=0) return -Infinity; return 10*Math.log10(power/refPwr); }

    async function initAudio(){
      stream = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:false, noiseSuppression:false, autoGainControl:false }});
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser(); analyser.fftSize = 2048;
      source = audioCtx.createMediaStreamSource(stream); source.connect(analyser);
    }

    function computeFramePower(){
      const buf = new Uint8Array(analyser.fftSize); analyser.getByteTimeDomainData(buf);
      let sumSq=0; for(let i=0;i<buf.length;i++){ const v=(buf[i]-128)/128; sumSq+=v*v; }
      const rms = Math.sqrt(sumSq/buf.length); return rms*rms;
    }

    async function calibrateOneSecond(){
      statusEl.textContent = 'æ ¡æº–ä¸­ï¼ˆ1 ç§’ï¼‰â€¦';
      const t0 = performance.now(); let acc=0,n=0;
      return new Promise(resolve=>{
        function tick(){
          const now = performance.now(); acc += computeFramePower(); n++;
          if(now - t0 >= CAL_MS){ refPower = Math.max(acc/Math.max(1,n), 1e-12); statusEl.textContent='å·²æ ¡æº–ï¼š0 dB'; calBadge.textContent='å·²æ ¡æº–'; resolve(); }
          else requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
      });
    }

    function setThresholdUI(val){
      thresholdDb = Number(val); threshText.textContent = `${thresholdDb} dB`;
      threshText.classList.remove('ok','warn'); if(thresholdDb<=15) threshText.classList.add('warn'); else threshText.classList.add('ok');
      chart.update('none'); // ä»¤é–¾å€¼ç·šä»¥æœ€æ–°æ•¸å€¼é‡ç•«
    }

    function flashPanel(){ panelEl.classList.add('flash'); setTimeout(()=>panelEl.classList.remove('flash'),200); }

    function beep(){ if(!audioCtx) return; const now=audioCtx.currentTime; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='square'; o.frequency.setValueAtTime(1000,now); g.gain.setValueAtTime(0.5,now); g.gain.exponentialRampToValueAtTime(0.0001,now+0.5); o.connect(g).connect(audioCtx.destination); o.start(now); o.stop(now+0.6); }

    function maybeAlert(db){
      if(!alertEnabled||!isFinite(db)) return; const t=performance.now();
      if(db>=thresholdDb){ panelEl.classList.add('alert'); if(t-lastBeepAt>BEEP_COOLDOWN_MS){ lastBeepAt=t; flashPanel(); beep(); } }
      else panelEl.classList.remove('alert');
    }

    function loop(){
      if(!isRunning) return; const now=performance.now(); const p=computeFramePower();
      frameBuf.push({t:now,p}); while(frameBuf.length && (now-frameBuf[0].t)>WINDOW_MS) frameBuf.shift();
      let sum=0; for(const it of frameBuf) sum+=it.p; const meanP=sum/Math.max(1,frameBuf.length);
      let db=0; if(refPower){ db=toDbRel(meanP,refPower); if(!isFinite(db)) db=0; }
      dbOut.textContent = `${db.toFixed(1)} dB`;

      // æ¯ç§’åŠ å…¥ä¸€é»
      if(startedAt!==null){ const s=Math.floor((now-startedAt)/1000); if(s!==lastRecordSec){ lastRecordSec=s; chart.data.labels.push(String(s)); chart.data.datasets[0].data.push(db); chart.update('none'); } }
      maybeAlert(db);
      rafId = requestAnimationFrame(loop);
    }

    async function startMeasure(){
      if(isRunning) return; isRunning=true; startBtn.disabled=true; stopBtn.disabled=false; statusEl.textContent='åˆå§‹åŒ–éŸ³è¨Šâ€¦';
      if(!audioCtx) await initAudio();
      calBtn.disabled=false; threshSel.disabled=false; alertToggle.disabled=false;
      // æ¸…ç©ºåœ–è¡¨å¾ 0 ç§’é–‹å§‹
      chart.data.labels=[]; chart.data.datasets[0].data=[]; chart.update('none'); startedAt=performance.now(); lastRecordSec=-1;
      await calibrateOneSecond();
      statusEl.textContent='é‡åº¦ä¸­ï¼ˆ3 ç§’å¹³å‡ï¼‰'; loop();
    }

    function stopMeasure(){ if(!isRunning) return; isRunning=false; startBtn.disabled=false; stopBtn.disabled=true; statusEl.textContent='å·²åœæ­¢'; if(rafId) cancelAnimationFrame(rafId); }

    async function recalibrate(){ statusEl.textContent='æº–å‚™æ ¡æº–â€¦è«‹ä¿æŒå®‰éœ'; await new Promise(r=>setTimeout(r,300)); await calibrateOneSecond(); }

    async function toggleWakeLock(){ if('wakeLock' in navigator){ try{ if(!wakeLock){ wakeLock=await navigator.wakeLock.request('screen'); wakeToggle.textContent='ğŸ’¡ è¢å¹•å¸¸äº®ï¼šé–‹'; wakeLock.addEventListener('release',()=>{ wakeToggle.textContent='ğŸ’¡ è¢å¹•å¸¸äº®ï¼šé—œ'; wakeLock=null; }); } else { await wakeLock.release(); wakeLock=null; wakeToggle.textContent='ğŸ’¡ è¢å¹•å¸¸äº®ï¼šé—œ'; } }catch(e){ alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´è¢å¹•å¸¸äº®æˆ–ç›®å‰ç„¡æ³•å•Ÿç”¨ã€‚'); } } else { alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´è¢å¹•å¸¸äº® (Screen Wake Lock API)ã€‚'); } }

    startBtn.addEventListener('click', startMeasure);
    stopBtn.addEventListener('click', stopMeasure);
    calBtn.addEventListener('click', recalibrate);
    threshSel.addEventListener('change', e=>setThresholdUI(e.target.value));
    alertToggle.addEventListener('click', async ()=>{ alertEnabled=!alertEnabled; alertToggle.textContent = alertEnabled? 'ğŸ”” æç¤ºå·²é–‹':'ğŸ”• æç¤ºå·²é—œ'; alertToggle.classList.toggle('secondary', alertEnabled); if(alertEnabled){ await calibrateOneSecond(); chart.data.labels=[]; chart.data.datasets[0].data=[]; chart.update('none'); startedAt=performance.now(); lastRecordSec=-1; } });
    wakeToggle.addEventListener('click', toggleWakeLock);

    setThresholdUI(thresholdDb);
  </script>
</body>
</html>
